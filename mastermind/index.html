<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mastermind</title>
    <script src="Chance.js"></script>
    <style>
        html, body {
            background-color: #1a2b45;
        }
        .center {
            margin: 0;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }
        .grid {
            display: grid;
            grid-template-columns: 72px 72px;
            grid-template-rows: 72px 72px;
            justify-content: center;
            margin: 1rem;
            cursor: pointer;
        }
        .grid div {
            border: 1px ridge slategray;
            padding: 15px;
            margin: 5px;
            box-shadow: 6px 3px 3px 0px black
        }
        .history .grid div {
            border: 1px ridge white;
        }
        .history {
            display: flex;
            position: relative;
            left: 0;
            flex-wrap: wrap;
            background-color: gray;
        }
        .history .grid {
            display: grid;
            grid-template-columns: 32px 32px;
            grid-template-rows: 32px 32px;
        }
        .history .circle div {
            width: 18px;
            height: 18px;
        }
        .history .circle div:hover {
            border: 1px ridge black !important;
        }
        .circle {
            display: flex;
            justify-content: center;
            cursor: pointer;
        }
        .circle div { 
            border: 2px ridge transparent;
            border-radius: 50%;

            width: 48px;
            height: 48px;
            box-shadow: 6px 3px 3px 0px black
        }
        .big {
            margin: 8px;
            gap: 15px;
        }
        .circle div {
            border: 4px ridge black;
        }
        .red {
            background-color: red;
        }
        .green {
            background-color: green;
        }
        .blue {
            background-color: blue;
        }
        .yellow {
            background-color: yellow;
        }
        .black {
            background-color: black;
        }
        .white {
            background-color: white;
        }
        .tryBtn {
            font-size: xx-large;
            margin: 4px;
        }
        .tries {
            border: 4px ridge;
            margin: 4px;
        }
        a { 
            color: white;
        }
    </style>
</head>
<body>
    <main class="center">
        <div>
            <a href="javascript:void(0)" onclick="history.back()" class="back">Back</a> | <a href="javascript:void(0);" onclick="newGame()" class="back">New Game</a> 
        </div>
        <div class="grid">
            <div></div>
            <div></div>
            <div></div>
            <div></div>
        </div>
        <div class="circle big">
            <div class="red"></div>
            <div class="green"></div>
            <div class="blue"></div>
            <div class="yellow"></div>
        </div>
        <a class="tryBtn" href="javascript:void(0)">Try</a>
        <div class="history">
        </div>
    </main>
    <script>
        let selectedTile = undefined;
        let selectedColor = undefined;
        let running       = false;
        const colorPicks = ["red", "green", "blue", "yellow"];
        let answer = [];

        onload = newGame;

        function newGame() {
            running = true;
            answer = [];

            for (let i =0; i < 4; ++i) {
                answer.push(Chance.pick(colorPicks));
            }

            const tiles = document.querySelectorAll(".grid div");

            tiles.forEach(tile => {
                tile.className = "";
            });

            const history = document.querySelector(".history");
            history.innerHTML = "";
        }

        const tryBtn = document.querySelector(".tryBtn");

        function checkColors(solution, guess) {
            let inPlace = 0;
            let notInPlace = 0;

            // Create a copy of the solution to track used colors
            let solutionCopy = [...solution];

            // First pass: Check for in-place matches
            for (let i = 0; i < guess.length; i++) {
                if (guess[i] === solution[i]) {
                    inPlace++;
                    solutionCopy[i] = null; // Mark as used
                    guess[i] = null; // Mark as checked
                }
            }

            // Second pass: Check for not-in-place matches
            for (let i = 0; i < guess.length; i++) {
                if (guess[i] !== null) {
                    let index = solutionCopy.indexOf(guess[i]);
                    if (index !== -1) {
                        notInPlace++;
                        solutionCopy[index] = null; // Mark as used
                    }
                }
            }

            return { inPlace, notInPlace };
        }

        tryBtn.onclick = e => {
            if (!running) return;
            const div   = document.createElement("div");
            const clone = document.querySelector(".grid").cloneNode(true);
            const cloneB = document.querySelector(".circle").cloneNode(true);
            const history = document.querySelector(".history");
            
            cloneB.classList.remove("big");

            let guess = [];
            div.className = "tries";

            for (let i = 0; i < clone.children.length; ++i) {
                const g = clone.children[i];
                guess.push(g.className);
                cloneB.children[i].className = "";
                cloneB.children[i].style.border = "1px ridge black";
            }

            const {inPlace, notInPlace} = checkColors(answer, guess);

            let j = 0;
            for (let i = 0; i < inPlace; ++i, ++j) {
                cloneB.children[j].className = "black";
            }

            for (let i = 0; i < notInPlace; ++i, ++j) {
                cloneB.children[j].className = "white";
            }

            div.appendChild(clone);
            div.appendChild(cloneB);

            history.appendChild(div);

            if (inPlace == 4 && running == true) {
                running = false;
                const value = Math.max(7 - history.children.length, 1);
                parent.giveCoin(value);
            }
        };

        const tiles = document.querySelectorAll(".grid div");
        const colors= document.querySelectorAll(".circle div");

        tiles.forEach(tile => {
            tile.onclick = e => {
                selectedTile = tile;
                if (tile.classList.contains(selectedColor)) {
                    tile.classList.remove(selectedColor);
                } else
                    tile.classList = selectedColor;
            };
            tile.onmouseenter = e => {
                tile.style.border = `2px ridge ${selectedColor}`;
            };
            tile.onmouseleave = e => {
                tile.style.border = ``;
            };
        });

        colors.forEach(color => {
            color.onclick = e => {
                const last = document.querySelector(`.circle .${selectedColor}`);
                if (last) {
                    last.style.border = "";
                }
                color.style.border = `4px inset white`;
                selectedColor = color.className;
            };
        });
    </script>
</body>
</html>
